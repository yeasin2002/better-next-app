version: '3'

vars:
  BINARY_NAME: better-next-app
  BUILD_DIR: ./bin

env:
  GO111MODULE: on
  CGO_ENABLED: 0

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: true

  # Development
  dev:
    desc: Run the application
    cmds:
      - go run main.go {{.CLI_ARGS}}

  # Build
  build:
    desc: Build for current platform
    cmds:
      - mkdir -p {{.BUILD_DIR}}
      - go build -o {{.BUILD_DIR}}/{{.BINARY_NAME}} .

  build:all:
    desc: Build for all platforms
    cmds:
      - mkdir -p {{.BUILD_DIR}}
      - GOOS=linux GOARCH=amd64 go build -o {{.BUILD_DIR}}/{{.BINARY_NAME}}-linux .
      - GOOS=darwin GOARCH=amd64 go build -o {{.BUILD_DIR}}/{{.BINARY_NAME}}-darwin .
      - GOOS=darwin GOARCH=arm64 go build -o {{.BUILD_DIR}}/{{.BINARY_NAME}}-darwin-arm64 .
      - GOOS=windows GOARCH=amd64 go build -o {{.BUILD_DIR}}/{{.BINARY_NAME}}.exe .

  # Dependencies
  deps:
    desc: Download dependencies
    cmds:
      - go mod download

  # Testing
  test:
    desc: Run tests
    cmds:
      - go test -v ./...

  # Code quality
  fmt:
    desc: Format code
    cmds:
      - go fmt ./...

  lint:
    desc: Run linter
    cmds:
      - golangci-lint run ./...

  vet:
    desc: Run go vet
    cmds:
      - go vet ./...

  check:
    desc: Run all checks
    cmds:
      - task: fmt
      - task: vet
      - task: lint
      - task: test

  # Cleaning
  clean:
    desc: Clean build artifacts
    cmds:
      - rm -rf {{.BUILD_DIR}}

  # Release
  release:
    desc: Create a new release with GoReleaser
    cmds:
      - goreleaser release --clean

  release:snapshot:
    desc: Build a snapshot release (no git tag required)
    cmds:
      - goreleaser release --snapshot --clean

  release:check:
    desc: Check GoReleaser configuration
    cmds:
      - goreleaser check

  # Setup
  setup:
    desc: Setup development environment
    cmds:
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install golang.org/x/tools/cmd/goimports@latest
      - task: deps
      - echo "Installing Lefthook..."
      - go install github.com/evilmartians/lefthook@latest
      - lefthook install
      - echo "Installing GoReleaser..."
      - go install github.com/goreleaser/goreleaser/v2@latest
      - echo "Setup complete!"

  # Git hooks helper
  validate-commit-msg:
    desc: Validate commit message format (used by git hooks)
    vars:
      COMMIT_MSG_FILE: '{{.COMMIT_MSG_FILE | default ".git/COMMIT_EDITMSG"}}'
    cmds:
      - |
        if grep -qE "^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\([a-zA-Z0-9_-]+\))?: .+" "{{.COMMIT_MSG_FILE}}"; then
          exit 0
        else
          echo ""
          echo "‚ùå Invalid commit message format!"
          echo ""
          echo "Commit message must follow Conventional Commits:"
          echo "  <type>(<scope>): <subject>"
          echo ""
          echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
          echo ""
          echo "Examples:"
          echo "  feat: add user authentication"
          echo "  fix(api): resolve null pointer error"
          echo "  docs: update README"
          echo ""
          echo "Your message:"
          cat "{{.COMMIT_MSG_FILE}}"
          echo ""
          exit 1
        fi
